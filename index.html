<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Happy Coin - Ù†Ø³Ø®Ù‡ 0.4.9 (Ø¢Ù¾Ø¯ÛŒØª Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØ¨Ù„ÛŒØº)</title>
<style>
  body { direction: rtl; font-family: Tahoma, sans-serif; background: #fffbe6; text-align: right; overflow-x:hidden; }
  #loginDiv, #gameDiv { max-width: 480px; margin: 20px auto; }
  input, button { font-size: 1rem; padding: 10px; margin: 5px; }
  input { width: 80%; border: 2px solid #c29200; border-radius: 5px; }
  button { background: #c29200; color: #fff; border: none; border-radius: 5px; cursor: pointer; transition: background .3s; }
  button:hover { background: #a17300; }
  #coinCanvas { cursor: pointer; margin-top: 20px; transition: transform .2s; }
  #coinCanvas.clicked { transform: scale(1.1); }

  .section { border: 2px solid #c29200; padding: 10px; margin-top: 20px; border-radius: 6px; background: #fff8d6; }
  #autoStatus { margin-top: 10px; color: #070; }

  /* ØªØ¨Ù„ÛŒØº Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ú©Ù†Ø§Ø± Ø³Ú©Ù‡ */
  #coinPromo {
    width: 200px; height: 80px;
    background: linear-gradient(135deg, #ffe066, #ff7f50);
    border-radius: 16px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 1000; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    overflow: hidden; animation: float 3s ease-in-out infinite alternate;
    position: fixed; /* Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø§Ø¨Øª Ù†Ø³Ø¨Øª Ø¨Ù‡ viewport */
    left: 50px; top: 150px; /* Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡Ø› ØªØ§Ø¨Ø¹ Ø¬Ø§Ú¯Ø°Ø§Ø±ÛŒ Ø§ØµÙ„Ø§Ø­Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ */
    transform-origin: center;
  }
  #coinPromo span { font-weight: bold; font-size: 1rem; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
  #coinPromo button { margin-top: 5px; padding: 6px 12px; background: #00bfff; border: none; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; animation: pulse 1.5s infinite; }

  @keyframes float {0%{transform:translateY(0) rotate(-2deg);}50%{transform:translateY(-8px) rotate(2deg);}100%{transform:translateY(0) rotate(-2deg);}}
  @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);}}

  /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ú©Ù…ØªØ± Ù…Ø²Ø§Ø­Ù… Ø¨Ø§Ø´Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ opacity ÛŒØ§ scale Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒ */
  #coinPromo.subtle { opacity: 0.95; transform: scale(0.98); }
</style>
</head>
<body>

<div id="loginDiv">
  <h2>Happy Coin ğŸ®</h2>
  <input id="usernameInput" placeholder="Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
  <br>
  <button id="loginBtn">ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
</div>

<div id="gameDiv" style="display:none;">
  <h2>Ø³Ù„Ø§Ù… <span id="userDisplay"></span>!</h2>
  <canvas id="coinCanvas" width="120" height="120"></canvas>
  <div id="count">Ø³Ú©Ù‡: 0</div>
  <div id="blackCount">Ø³ÛŒØ§Ù‡: 0</div>

  <!-- ØªØ¨Ù„ÛŒØº Ú©Ù†Ø§Ø± Ø³Ú©Ù‡ -->
  <div id="coinPromo" aria-hidden="false">
    <span>ğŸ’° Happy Coin:Crypto War!</span>
    <button id="promoBtn" aria-label="Ø´Ø±ÙˆØ¹">Ø´Ø±ÙˆØ¹</button>
  </div>

  <div class="section">
    <button id="darkModeBtn">ØªØºÛŒÛŒØ± ØªÙ… (Ø±Ø§ÛŒÚ¯Ø§Ù†)</button>
    <button id="autoBtn">Auto-Click (Û´Ûµ Ø³ÛŒØ§Ù‡)</button>
    <div id="autoStatus"></div>
  </div>

  <div class="section">
    <h3>Ø®Ø±ÛŒØ¯ Ø·Ø¨Ù‚Ø§Øª (+Û±Ûµ Ø³ÛŒØ§Ù‡)</h3>
    <div id="floors"></div>
  </div>

  <div class="section">
    <button id="cheatBtn">Ú©Ø¯ ØªÙ‚Ù„Ø¨</button>
  </div>

  <button id="eventBtn">Ø§ÛŒÙˆÙ†Øª (Û±Û±Û°Û° Ø³Ú©Ù‡)</button>
  <div id="footer">Ù†Ø³Ø®Ù‡: 0.4.9 | Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· <strong>Rob Lucci</strong></div>
</div>

<script>
/* --------------------- Ø°Ø®ÛŒØ±Ù‡ / Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ --------------------- */
let db={}, currentUser=null;

function save(){
  try{
    if(currentUser) localStorage.setItem('hcUser', currentUser);
    localStorage.setItem('hcData', JSON.stringify(db));
  }catch(e){
    console.warn('save error', e);
  }
}
function load(){
  try{
    const stored=localStorage.getItem('hcData');
    if(stored) db=JSON.parse(stored);
    const u=localStorage.getItem('hcUser');
    if(u) currentUser=u;
  }catch(e){
    console.warn('load error', e);
  }
}
load();

/* --------------------- UI Ø§ØµÙ„ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒ --------------------- */
const loginBtn=document.getElementById('loginBtn');
const usernameInput=document.getElementById('usernameInput');
const canvas=document.getElementById('coinCanvas'), ctx=canvas.getContext('2d');

loginBtn.onclick=()=>{
  const name = String(usernameInput.value || '').trim();
  if(name.length < 2){ alert('Ø§Ø³Ù… Ú©ÙˆØªØ§Ù‡ Ø§Ø³Øª'); return; }
  if(!db[name]) db[name] = { coins:0, black:0, floors:0, dark:false, cheats:[] };
  currentUser = name;
  save();
  showGame();
};

// ÙˆØ±ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡
window.addEventListener('DOMContentLoaded', ()=>{
  if(currentUser && db[currentUser]) {
    // ÛŒÚ© ØªØ£Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ù†Ø¯Ø± Ú©Ø§Ù…Ù„ DOM
    setTimeout(()=> {
      try{ showGame(); }catch(e){ console.warn('autologin showGame error', e); }
    }, 50);
  }
});

function showGame(){
  document.getElementById('loginDiv').style.display = 'none';
  document.getElementById('gameDiv').style.display = 'block';
  document.getElementById('userDisplay').innerText = currentUser;
  renderUI();
  bindEvents();
  initPromoPositioning(); // Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒØ¯Ù‡ÛŒ ØªØ¨Ù„ÛŒØº
}

function renderUI(){
  const u = db[currentUser] || { coins:0, black:0, floors:0, dark:false };
  document.getElementById('count').innerText = 'Ø³Ú©Ù‡: ' + (u.coins || 0);
  document.getElementById('blackCount').innerText = 'Ø³ÛŒØ§Ù‡: ' + (u.black || 0);
  document.body.classList.toggle('dark', !!u.dark);
  drawCoin();
  renderFloors();
}

/* Ø³Ú©Ù‡ */
function drawCoin(){
  try{
    const cx=60, cy=60, r=50;
    const g=ctx.createRadialGradient(cx-10,cy-10,10,cx,cy,r);
    g.addColorStop(0,'#fff2a8'); g.addColorStop(.5,'#ffd700'); g.addColorStop(1,'#b8860b');
    ctx.clearRect(0,0,120,120);
    ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI);
    ctx.fillStyle=g; ctx.fill(); ctx.lineWidth=4; ctx.strokeStyle='#e5c100'; ctx.stroke();
  }catch(e){
    console.warn('drawCoin error', e);
  }
}
canvas.addEventListener('click', ()=>{ canvas.classList.add('clicked'); setTimeout(()=>canvas.classList.remove('clicked'),200); clickCoin(); });

function clickCoin(){
  try{
    const u = db[currentUser];
    u.coins = (u.coins||0) + 1;
    if(u.coins % 15 === 0) u.black = (u.black||0) + 1;
    save(); renderUI();
  }catch(e){ console.warn('clickCoin error', e); }
}

/* Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
function bindEvents(){
  document.getElementById('darkModeBtn').onclick = ()=>{ const u=db[currentUser]; u.dark = !u.dark; save(); renderUI(); };
  document.getElementById('autoBtn').onclick = buyAuto;
  document.getElementById('cheatBtn').onclick = applyCheat;
  document.getElementById('eventBtn').onclick = startEvent;
  document.getElementById('promoBtn').onclick = ()=> window.open('https://rob-lucci63.github.io/Happy-Coin-Crypto-War/','_blank');
}

/* Ø®Ø±ÛŒØ¯ Ø§ØªÙˆ Ùˆ Ø·Ø¨Ù‚Ø§Øª Ùˆ ØªÙ‚Ù„Ø¨ */
function buyAuto(){
  try{
    const u = db[currentUser];
    if((u.black||0) < 45){ alert('Ø³ÛŒØ§Ù‡ Ú©Ù… Ø§Ø³Øª'); return; }
    u.black -= 45; save(); renderUI(); alert('Auto-Click ÙØ¹Ø§Ù„ Ø´Ø¯');
  }catch(e){ console.warn('buyAuto error', e); }
}

function renderFloors(){
  try{
    const u = db[currentUser] || {};
    const ct = document.getElementById('floors'); ct.innerHTML = '';
    for(let i=1;i<=5;i++){
      const btn = document.createElement('button');
      btn.innerText = (i <= (u.floors||0) ? 'âœ… ':'ğŸª™ ') + 'Ø·Ø¨Ù‚Ù‡ '+i+' - '+(i*1000)+' Ø³Ú©Ù‡';
      if(i > (u.floors||0)){
        btn.onclick = ()=> {
          if((u.coins||0) < i*1000) { alert('Ø³Ú©Ù‡ Ú©Ù… Ø§Ø³Øª'); return; }
          u.coins -= i*1000; u.black = (u.black||0) + 15; u.floors = i; save(); renderUI(); alert('Ø®Ø±ÛŒØ¯ Ø´Ø¯');
        };
      } else { btn.disabled = true; }
      ct.appendChild(btn);
    }
  }catch(e){ console.warn('renderFloors error', e); }
}

function applyCheat(){ try{
  let c = prompt('Ú©Ø¯ ØªÙ‚Ù„Ø¨:'); if(!c) return;
  const u = db[currentUser];
  c = String(c).trim().toLowerCase();
  if(c === 'fff') u.coins = (u.coins||0) + 600;
  else if(c === 'ff') u.black = (u.black||0) + 25;
  else { alert('Ú©Ø¯ ØºÙ„Ø·'); return; }
  save(); renderUI();
}catch(e){ console.warn('applyCheat error', e); } }

function startEvent(){ alert('Ø§ÛŒÙˆÙ†Øª Ø´Ø±ÙˆØ¹ Ø´Ø¯!'); }

/* --------------------- ØªØ¨Ù„ÛŒØº Ú©Ù†Ø§Ø± Ø³Ú©Ù‡: Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© Ùˆ Ù…Ù‚Ø§ÙˆÙ… --------------------- */
function positionPromoNearCoin(tryCount = 0){
  try{
    const promo = document.getElementById('coinPromo');
    if(!promo) return;
    const cRect = canvas.getBoundingClientRect();
    // Ø§Ú¯Ø± canvas Ù‡Ù†ÙˆØ² ØµÙØ±Ù‡ ÛŒØ§ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¯ÛŒØ¯ Ù‡Ø³ØªØŒ ØªØ§ 5 Ø¨Ø§Ø± Ø¨Ø§ ØªØ£Ø®ÛŒØ± Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†
    if((cRect.width === 0 && tryCount < 6) || isNaN(cRect.top)){
      return setTimeout(()=>positionPromoNearCoin(tryCount+1), 80);
    }
    const promoRect = promo.getBoundingClientRect();
    // Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø§ÙˆÙ„ÛŒÙ‡: Ø³Ù…Øª Ø±Ø§Ø³Øª Ú©Ø§Ù†ÙˆØ§Ø³
    let left = Math.round(cRect.right + 10);
    let top = Math.round(cRect.top + (cRect.height/2) - (promoRect.height/2));

    // Ø§Ú¯Ø± Ø§Ø² ØµÙØ­Ù‡ Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒØ±Ù‡ Ø³Ù…Øª Ú†Ù¾ Ø¨Ø°Ø§Ø±
    if(left + promoRect.width > window.innerWidth - 10){
      left = Math.round(cRect.left - promoRect.width - 10);
    }
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ú©Ù†Ø§Ø±Ù‡â€ŒÙ‡Ø§
    if(left < 10) left = 10;
    if(top < 10) top = 10;
    if(top + promoRect.height > window.innerHeight - 10) top = Math.max(10, window.innerHeight - promoRect.height - 10);

    // Ø§Ø¹Ù…Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª
    promo.style.left = left + 'px';
    promo.style.top = top + 'px';
    // Ø¨Ø®Ø§Ø·Ø± animation float Ú©Ù‡ translateY Ù…ÛŒØ²Ù†Ù‡ØŒ position Ø«Ø§Ø¨Øª Ø¨Ù‡ØªØ± Ø¯ÛŒØ¯Ù‡ Ù…ÛŒØ´Ù‡
    promo.style.position = 'fixed';
  }catch(e){
    // Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø®Ø·Ø§ Ø¨Ø§Ø´Ù‡ØŒ ÛŒÚ©Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ø± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
    if(tryCount < 6) setTimeout(()=>positionPromoNearCoin(tryCount+1), 100);
    console.warn('positionPromo error', e);
  }
}

// init: ÙÙ‚Ø· ÛŒÚ© Ø¯ÙØ¹Ù‡ listener Ù‡Ø§ Ø±Ùˆ ÙˆØµÙ„ Ú©Ù†
function initPromoPositioning(){
  positionPromoNearCoin();
  if(window._hcPromoResizeInitialized) return;
  window._hcPromoResizeInitialized = true;

  // throttle helper
  let tmr = null;
  const schedule = ()=>{
    clearTimeout(tmr);
    tmr = setTimeout(()=>positionPromoNearCoin(), 120);
  };
  window.addEventListener('resize', schedule);
  window.addEventListener('orientationchange', schedule);
  window.addEventListener('scroll', schedule, { passive: true });
}

/* --------------------- Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø± --------------------- */
</script>

</body>
</html>