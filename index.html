<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy Coin - نسخه 0.1.6</title>
  <!-- Vazir Font for pixelated Persian text -->
  <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
  <!-- CryptoJS for AES encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body { background: #fdf6e3; font-family: 'Vazir', monospace; text-align: center; padding: 20px; transition: background 0.5s, color 0.5s; }
    body.dark { background: #121212; color: #eee; }
    #loginDiv,#gameDiv{max-width:480px;margin:auto;}
    h1{color:#c29200;text-shadow:2px 2px 0 #7a5700;margin-bottom:20px;}
    #coin{width:150px;height:150px;cursor:pointer;image-rendering:pixelated;border-radius:50%;transition:transform .15s ease;}
    #coin.clicked{transform:scale(1.1) rotate(10deg);}
    #count,#blackCoins{font-size:14px;margin:10px 0;color:#7a5700;text-shadow:1px 1px 0 #f0e68c;}
    button{background:#c29200;border:none;color:#fff;padding:8px 16px;font-family:'Vazir',monospace;font-size:12px;margin:5px;border-radius:4px;cursor:pointer;box-shadow:2px 2px 0 #7a5700;transition:background .3s;}
    button:hover{background:#a17300;}
    button:disabled{background:#999;cursor:default;}
    input[type="text"]{font-family:'Vazir',monospace;font-size:12px;padding:6px;width:70%;border:2px solid #c29200;border-radius:4px;background:#fffbe6;text-align:center;color:#7a5700;}
    .info{display:inline-block;width:16px;height:16px;background:#ffc107;color:#000;border-radius:50%;font-size:12px;line-height:16px;text-align:center;cursor:pointer;margin-right:5px;}
    .tooltip{display:none;position:absolute;background:#333;color:#fff;padding:6px;border-radius:4px;font-size:12px;max-width:200px;z-index:100;}
    #shop,#dailyChallenge,#clickChallenge,#cheatDiv{margin-top:20px;background:#fff8d6;border:2px solid #c29200;border-radius:6px;padding:10px;}
    #autoStatus{font-size:12px;color:#5a3e00;margin-top:10px;}
    #trafficLight{width:80px;height:200px;background:#333;border-radius:15px;margin:10px auto;padding:5px;display:none;}
    .light{width:50px;height:50px;border-radius:50%;margin:8px auto;background:#111;}
    .green{background:green;}
    .yellow{background:orange;}
    .red{background:red;}
    #clickBtn{display:none;margin-top:10px;}
    #timer{font-size:14px;margin-top:10px;color:#d9534f;}
    #footer{margin-top:30px;font-size:10px;color:#7a5700;}
  </style>
</head>
<body>
  <div id="loginDiv">
    <h1>Happy Coin 🎮</h1>
    <button onclick="login()">ورود / ثبت‌نام</button>
  </div>

  <div id="gameDiv" style="display:none;">
    <h1>سلام <span id="displayName"></span>!</h1>
    <div>
      <span class="info" onmouseover="showTooltip(event,'کلیک +1 سکه عادی؛ هر ۱۵ کلیک +1 سکه سیاه')" onmouseout="hideTooltip()">!</span>
      <img id="coin" src="https://i.postimg.cc/nrWTP5cb/coin-pixel.png" alt="سکه" onclick="addCoin()">
    </div>
    <div id="count">تعداد سکه: 0</div>
    <div id="blackCoins">سکه سیاه: 0</div>

    <div id="shop">
      <h3>🛒 فروشگاه</h3>
      <span class="info" onmouseover="showTooltip(event,'تغییر تم روشن/تاریک رایگان')" onmouseout="hideTooltip()">!</span>
      <button onclick="toggleDark()">تغییر تم</button>
      <br>
      <span class="info" onmouseover="showTooltip(event,'Auto-Click: هر ۰.۵ ثانیه +1 سکه، ۵ دقیقه (45 سکه سیاه)')" onmouseout="hideTooltip()">!</span>
      <button id="btnAuto" onclick="buyAuto()" >خرید Auto-Click</button>
      <div id="autoStatus"></div>
    </div>

    <div id="dailyChallenge">
      <h3>🏠 چالش روزانه - طبقات</h3>
      <span class="info" onmouseover="showTooltip(event,'هر طبقه +15 سکه سیاه با خرید')" onmouseout="hideTooltip()">!</span>
      <div id="floorsContainer"></div>
    </div>

    <div id="clickChallenge">
      <h3>🎯 چالش کلیک</h3>
      <span class="info" onmouseover="showTooltip(event,'پرداخت 1000 سکه برای چالش 30 ثانیه‌ای')" onmouseout="hideTooltip()">!</span>
      <button id="startBtn" onclick="startClickChallenge()">شروع چالش</button>
      <div id="trafficLight">
        <div id="light3" class="light"></div>
        <div id="light2" class="light"></div>
        <div id="light1" class="light"></div>
      </div>
      <button id="clickBtn" onclick="handleClickChallenge()">کلیک کن!</button>
      <div id="timer"></div>
    </div>

    <div id="cheatDiv">
      <h3>💻 کد تقلب</h3>
      <span class="info" onmouseover="showTooltip(event,'fff, ff, cp9, ty')" onmouseout="hideTooltip()">!</span>
      <button onclick="toggleCheat()">نمایش/مخفی کردن</button>
      <div id="cheatBox" style="display:none;">
        <input type="text" id="cheatCode" placeholder="کد را وارد کنید">
        <button onclick="applyCheat()">اعمال کد</button>
      </div>
    </div>

    <div id="footer">نسخه: 0.1.6 | ساخته‌شده توسط Rob Lucci</div>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script>
    // AES Encryption
    const ENCRYPTION_KEY = "RobLucci💎SecretKey_2025";
    function encryptData(d){return CryptoJS.AES.encrypt(JSON.stringify(d),ENCRYPTION_KEY).toString();}
    function decryptData(c){try{const b=CryptoJS.AES.decrypt(c,ENCRYPTION_KEY);return JSON.parse(b.toString(CryptoJS.enc.Utf8));}catch{return {};}}

    // Load/Save
    function saveData(){
      localStorage.setItem("happyCoinUsers", encryptData(usersData));
      localStorage.setItem("usedCheatCodes", encryptData(usedCheatCodes));
    }
    function loadData(){
      const u = localStorage.getItem("happyCoinUsers");
      const c = localStorage.getItem("usedCheatCodes");
      usersData = u ? decryptData(u) : {};
      usedCheatCodes = c ? decryptData(c) : [];
    }

    let currentUser=null, usersData={}, usedCheatCodes=[];
    loadData();

    // Sound
    const clickSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');
    clickSound.volume = 0.3;

    // Auto-Click
    let autoInterval=null, autoTimeout=null;

    // Challenge
    const maxFloor = 5, floorBase=1000;
    let lightState='red', challengeInterval=null, countdownInterval=null;
    let remaining=0, earned=0, inChallenge=false;

    // Tooltip
    function showTooltip(e,t){
      const tip=document.getElementById("tooltip");
      tip.innerText=t;
      tip.style.left=e.pageX+5+'px';
      tip.style.top=e.pageY+5+'px';
      tip.style.display='block';
    }
    function hideTooltip(){document.getElementById("tooltip").style.display='none';}

    // Init
    window.onload=()=>{
      const s=localStorage.getItem("happyCoinCurrentUser");
      if(s && usersData[s]) { currentUser=s; showGame(); }
    };
    function initUser(n){ if(!usersData[n]) usersData[n]={coins:0,blackCoins:0,floorsBought:0,darkMode:false}; saveData(); }

    // Login
    function login(){
      const n=prompt("اسم خود را وارد کنید (حداقل ۲ حرف):");
      if(!n||n.trim().length<2){alert("اسم باید حداقل ۲ حرف باشد"); return;}
      currentUser=n.trim(); initUser(currentUser);
      localStorage.setItem("happyCoinCurrentUser",currentUser);
      saveData(); showGame();
    }
    function showGame(){
      document.getElementById("loginDiv").style.display='none';
      document.getElementById("gameDiv").style.display='block';
      updateUI();
    }

    // Update UI
    function updateUI(){
      const u=usersData[currentUser];
      document.getElementById("displayName").innerText=currentUser;
      document.getElementById("count").innerText="تعداد سکه: "+u.coins;
      document.getElementById("blackCoins").innerText="سکه سیاه: "+u.blackCoins;
      document.body.classList.toggle("dark",u.darkMode);
      renderFloors();
      document.getElementById("timer").innerText="";
    }

    // Floors
    function renderFloors(){
      const u=usersData[currentUser];
      let html="";
      for(let i=1;i<=maxFloor;i++){
        html+=`<button onclick="buyFloor(${i})" ${i<=u.floorsBought?"disabled":""}>${i<=u.floorsBought?"✅":"🪙"} طبقه ${i} - ${floorBase*i}</button>`;
      }
      document.getElementById("floorsContainer").innerHTML=html;
    }
    function buyFloor(i){
      const u=usersData[currentUser], cost=floorBase*i;
      if(u.coins<cost){alert("سکه کافی نیست"); return;}
      u.coins-=cost; u.blackCoins+=15; u.floorsBought=i;
      saveData(); updateUI(); alert(`طبقه ${i} خرید و 15 سکه سیاه دریافت شد!`);
    }

    // Coin Click
    function addCoin(){
      if(!currentUser){ login(); return; }
      const u=usersData[currentUser];
      u.coins++; if(u.coins%15===0) u.blackCoins++;
      if(clickSound.paused) clickSound.play();
      saveData(); updateUI();
    }

    // Dark Mode
    function toggleDark(){
      const u=usersData[currentUser];
      u.darkMode=!u.darkMode; saveData(); updateUI();
    }

    // Auto-Click
    function buyAuto(){
      const u=usersData[currentUser];
      if(u.blackCoins<45){ alert("سکه سیاه کافی نیست"); return; }
      u.blackCoins-=45; saveData(); updateUI();
      document.getElementById("autoStatus").innerText="Auto-Click فعال شد";
      clearInterval(autoInterval); clearTimeout(autoTimeout);
      autoInterval=setInterval(()=>{
        u.coins++; if(u.coins%15===0) u.blackCoins++; saveData(); updateUI();
      },500);
      autoTimeout=setTimeout(()=>{
        clearInterval(autoInterval);
        document.getElementById("autoStatus").innerText="Auto-Click پایان یافت";
      },5*60*1000);
    }

    // Click Challenge
    function startClickChallenge(){
      if(inChallenge) return;
      const u=usersData[currentUser];
      if(u.coins<1000){ alert("سکه کافی نیست"); return; }
      u.coins-=1000; saveData(); updateUI();
      inChallenge=true; earned=0; remaining=30;
      document.getElementById("trafficLight").style.display="block";
      document.getElementById("clickBtn").style.display="inline-block";
      document.getElementById("timer").innerText="زمان باقی‌مانده: "+remaining;
      clearInterval(countdownInterval); clearInterval(challengeInterval);
      countdownInterval=setInterval(()=>{
        remaining--; document.getElementById("timer").innerText="زمان باقی‌مانده: "+remaining;
        if(remaining<=0) endChallenge();
      },1000);
      runLight();
    }
    function runLight(){
      function cycle(){
        if(!inChallenge) return;
        document.querySelectorAll(".light").forEach(el=>el.className="light");
        const r=Math.random();
        if(r<0.4) { lightState="green"; document.getElementById("light3").classList.add("green"); }
        else if(r<0.7) { lightState="yellow"; document.getElementById("light2").classList.add("yellow"); }
        else { lightState="red"; document.getElementById("light1").classList.add("red"); }
      }
      cycle(); challengeInterval=setInterval(cycle,2000);
    }
    function handleClickChallenge(){
      if(!inChallenge) return;
      const u=usersData[currentUser];
      if(lightState==="green"){ u.blackCoins++; earned++; saveData(); updateUI(); }
      else if(lightState==="red"){ u.blackCoins=0; saveData(); updateUI(); alert("باختی!"); endChallenge(); }
    }
    function endChallenge(){
      inChallenge=false;
      clearInterval(challengeInterval); clearInterval(countdownInterval);
      document.getElementById("trafficLight").style.display="none";
      document.getElementById("clickBtn").style.display="none";
      document.getElementById("timer").innerText="";
      alert("پایان! سکه سیاه کسب شده: "+earned);
    }

    // Cheat Codes
    function toggleCheat(){
      const box=document.getElementById("cheatBox");
      box.style.display = box.style.display==="none" ? "block" : "none";
    }
    function applyCheat(){
      const code=document.getElementById("cheatCode").value.trim().toLowerCase();
      if(!code){ alert("کد خالی"); return; }
      if(usedCheatCodes.includes(currentUser+"_"+code)){ alert("این کد قبلاً استفاده شده"); return; }
      const u=usersData[currentUser];
      if(code==="fff"){ u.coins+=600; }
      else if(code==="ff"){ u.blackCoins+=25; }
      else if(code==="cp9"){ u.coins+=1000; u.blackCoins+=30; }
      else if(code==="ty"){ u.coins+=2000; u.blackCoins+=50; }
      else { alert("کد اشتباه"); return; }
      usedCheatCodes.push(currentUser+"_"+code); saveData(); updateUI();
      alert("کد با موفقیت اعمال شد!"); document.getElementById("cheatCode").value="";
    }
  </script>
</body>
</html>
